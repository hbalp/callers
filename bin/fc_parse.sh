#!/bin/bash
#set -x
#     Copyright (C) 2015 Thales Communication & Security
#       - All Rights Reserved
#     coded by Hugues Balp
#     This file generates a script for parsing with frama-c some preprocessed src files

function fc_parse ()
{
  #exename=$1
  fc_filter_files_with_main_entrypoints "fc_entrypoints.gen.preproc_files"
  fc_select_preproc_files #$exename
}

# filter potential main entrypoint functions to avoid conflicts reported by frama-c during parsing
function fc_filter_files_with_main_entrypoints ()
{
  fc_entrypoints_preproc_files=$1
  curdir=${PWD}
  # list preprocessed files containing "main(" word
  fc_main_entryppoint_files=`find . -name "*.i" -exec egrep -l "\bmain\(" {} \;`
  # rename preprocessed files containing "main(" word
  for f in ${fc_main_entryppoint_files};
  do
    echo "WARNING: found main() entry point declaration in file $f, so we rename it into $f.main to avoid conflicts reported by frama-c during parsing" >> /dev/stderr
    mv $f $f.main
  done
  fc_renamed_main_entrypoint_files=`find . -name "*.i.main" | awk '{ print $1 " \\\" }'`
  cat > ${fc_entrypoints_preproc_files} <<EOF
#!/bin/bash
# Potential main entrypoint files filtered by fc_parse.sh
${fc_renamed_main_entrypoint_files}
EOF
}

# you should first call function fc_filter_files_with_main_entrypoints
# to avoid conflicts between potential main entrypoint functions reported by frama-c during parsing
function fc_select_preproc_files ()
{
  #exename=$1
  curdir=${PWD}
  preproc_files=`find ${curdir} -type f -name "*.i" | awk '{ print $1 " \\\" }'`
  fc_parse_prepro_files="fc_parse_preproc_files.gen.sh"
  fc_parsed_data="fc_parsed.gen.sav"
  fc_parse_args="-save ${fc_parsed_data}"

  cat > ${fc_parse_prepro_files} <<EOF
#!/bin/bash
# Generated by fc_parse.sh in dir ${curdir}

frama-c \\
${preproc_files}
${fc_parse_args}
EOF
}
